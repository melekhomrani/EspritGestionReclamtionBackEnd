package tn.esprit.mailingservice;

import jakarta.mail.internet.MimeMessage;
import lombok.RequiredArgsConstructor;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.mail.SimpleMailMessage;
import org.springframework.mail.javamail.JavaMailSender;
import org.springframework.mail.javamail.MimeMessageHelper;
import org.springframework.stereotype.Service;

@Service
@RequiredArgsConstructor
public class EmailServiceImpl implements EmailService {
    private final JavaMailSender javaMailSender;
    @Value("${spring.mail.username}") private String sender;

    public String sendMailWithAttachements(EmailDetails details){
        MimeMessage mimeMessage = javaMailSender.createMimeMessage();
        MimeMessageHelper mimeMessageHelper;
        //meghir ma tzid thymeleaf zeyed ken t7eb tzid template okhra ekhdemha win 7ajtek w copy paste it hne w just concati les variables te3ek fl string.
        String htmlButton = "<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Transitional//EN\" \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\"><html lang=\"en\"><head data-id=\"__react-email-head\"><meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\"/></head><div id=\"__react-email-preview\" style=\"display:none;overflow:hidden;line-height:1px;opacity:0;max-height:0;max-width:0\">" + details.getPreviewText() + "<div> \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF</div></div><body data-id=\"__react-email-body\" style=\"background-color:rgb(255,255,255);margin-top:auto;margin-bottom:auto;margin-left:auto;margin-right:auto;font-family:ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica Neue, Arial, Noto Sans, sans-serif, Apple Color Emoji, Segoe UI Emoji, Segoe UI Symbol, Noto Color Emoji\"><table align=\"center\" width=\"100%\" data-id=\"__react-email-container\" role=\"presentation\" cellSpacing=\"0\" cellPadding=\"0\" border=\"0\" style=\"max-width:37.5em;border-width:1px;border-style:solid;border-color:rgb(234,234,234);border-radius:0.25rem;margin-top:40px;margin-bottom:40px;margin-left:auto;margin-right:auto;padding:20px;width:465px\"><tbody><tr style=\"width:100%\"><td><table align=\"center\" width=\"100%\" data-id=\"react-email-section\" border=\"0\" cellPadding=\"0\" cellSpacing=\"0\" role=\"presentation\" style=\"margin-top:32px\"><tbody><tr><td><img data-id=\"react-email-img\" alt=\"Esprit\" src=\"https://iili.io/H88O9F1.md.png\" width=\"100\" style=\"display:block;outline:none;border:none;text-decoration:none;margin-top:0px;margin-bottom:0px;margin-left:auto;margin-right:auto\"/></td></tr></tbody></table><h1 data-id=\"react-email-heading\" style=\"color:rgb(0,0,0);font-size:24px;font-weight:400;text-align:center;padding:0px;margin-top:30px;margin-bottom:30px;margin-left:0px;margin-right:0px\">" +details.getTitle() + "</h1><p data-id=\"react-email-text\" style=\"font-size:14px;line-height:24px;margin:16px 0;color:rgb(0,0,0)\">" + details.getGreeting() + "</p><p data-id=\"react-email-text\" style=\"font-size:14px;line-height:24px;margin:16px 0;color:rgb(0,0,0)\"><strong>" + details.getMsgBody() + "</strong></p><table align=\"center\" width=\"100%\" data-id=\"react-email-section\" border=\"0\" cellPadding=\"0\" cellSpacing=\"0\" role=\"presentation\" style=\"text-align:center;margin-top:32px;margin-bottom:32px\"><tbody><tr><td><a href=\"" + details.getButtonLink() + "\" data-id=\"react-email-button\" target=\"_blank\" style=\"line-height:100%;text-decoration:none;display:inline-block;max-width:100%;padding:12px 20px;background-color:rgb(0,0,0);border-radius:0.25rem;color:rgb(255,255,255);font-size:12px;font-weight:600;text-decoration-line:none;text-align:center\"><span></span><span style=\"max-width:100%;display:inline-block;line-height:120%;mso-padding-alt:0px;mso-text-raise:9px\">" + details.getButtonText() + "</span><span></span></a></td></tr></tbody></table><p data-id=\"react-email-text\" style=\"font-size:14px;line-height:24px;margin:16px 0;color:rgb(0,0,0)\">Ou copiez et collez le lien dans votre navigateur: <a href=\"" + details.getButtonLink() + "\" data-id=\"react-email-link\" target=\"_blank\" style=\"color:rgb(37,99,235);text-decoration:none;text-decoration-line:none\">" + details.getButtonLink() + "</a></p><hr data-id=\"react-email-hr\" style=\"width:100%;border:none;border-top:1px solid #eaeaea;border-width:1px;border-style:solid;border-color:rgb(234,234,234);margin-top:26px;margin-bottom:26px;margin-left:0px;margin-right:0px\"/><p data-id=\"react-email-text\" style=\"font-size:12px;line-height:24px;margin:16px 0;color:rgb(102,102,102)\">Cette notification est envoyé par <span style=\"color:rgb(0,0,0)\">Systeme CRM Esprit</span> Localize a <span style=\"color:rgb(0,0,0)\">Ariana, Tunisie</span>. Si vous n&#x27;ette pas le destinataire de cette notification, veuillez ignorer ce message.</p></td></tr></tbody></table></body></html>";
        String htmlNoButton = "<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Transitional//EN\" \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\"><html lang=\"en\"><head data-id=\"__react-email-head\"><meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\"/></head><div id=\"__react-email-preview\" style=\"display:none;overflow:hidden;line-height:1px;opacity:0;max-height:0;max-width:0\">" + details.getPreviewText() + "<div> \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF \u200C\u200B\u200D\u200E\u200F\uFEFF</div></div><body data-id=\"__react-email-body\" style=\"background-color:rgb(255,255,255);margin-top:auto;margin-bottom:auto;margin-left:auto;margin-right:auto;font-family:ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica Neue, Arial, Noto Sans, sans-serif, Apple Color Emoji, Segoe UI Emoji, Segoe UI Symbol, Noto Color Emoji\"><table align=\"center\" width=\"100%\" data-id=\"__react-email-container\" role=\"presentation\" cellSpacing=\"0\" cellPadding=\"0\" border=\"0\" style=\"max-width:37.5em;border-width:1px;border-style:solid;border-color:rgb(234,234,234);border-radius:0.25rem;margin-top:40px;margin-bottom:40px;margin-left:auto;margin-right:auto;padding:20px;width:465px\"><tbody><tr style=\"width:100%\"><td><table align=\"center\" width=\"100%\" data-id=\"react-email-section\" border=\"0\" cellPadding=\"0\" cellSpacing=\"0\" role=\"presentation\" style=\"margin-top:32px\"><tbody><tr><td><img data-id=\"react-email-img\" alt=\"Esprit\" src=\"https://iili.io/H88O9F1.md.png\" width=\"100\" style=\"display:block;outline:none;border:none;text-decoration:none;margin-top:0px;margin-bottom:0px;margin-left:auto;margin-right:auto\"/></td></tr></tbody></table><h1 data-id=\"react-email-heading\" style=\"color:rgb(0,0,0);font-size:24px;font-weight:400;text-align:center;padding:0px;margin-top:30px;margin-bottom:30px;margin-left:0px;margin-right:0px\">" +details.getTitle() + "</h1><p data-id=\"react-email-text\" style=\"font-size:14px;line-height:24px;margin:16px 0;color:rgb(0,0,0)\">" + details.getGreeting() + "</p><p data-id=\"react-email-text\" style=\"font-size:14px;line-height:24px;margin:16px 0;color:rgb(0,0,0)\"><strong>" + details.getMsgBody() + "</strong></p><table align=\"center\" width=\"100%\" data-id=\"react-email-section\" border=\"0\" cellPadding=\"0\" cellSpacing=\"0\" role=\"presentation\" style=\"text-align:center;margin-top:32px;margin-bottom:32px\"><tbody><tr><td></td></tr></tbody></table><hr data-id=\"react-email-hr\" style=\"width:100%;border:none;border-top:1px solid #eaeaea;border-width:1px;border-style:solid;border-color:rgb(234,234,234);margin-top:26px;margin-bottom:26px;margin-left:0px;margin-right:0px\"/><p data-id=\"react-email-text\" style=\"font-size:12px;line-height:24px;margin:16px 0;color:rgb(102,102,102)\">Cette notification est envoyé par <span style=\"color:rgb(0,0,0)\">Systeme CRM Esprit</span> Localize a <span style=\"color:rgb(0,0,0)\">Ariana, Tunisie</span>. Si vous n&#x27;ette pas le destinataire de cette notification, veuillez ignorer ce message.</p></td></tr></tbody></table></body></html>";
        String html;
        if(details.getWithButton()){
            html = htmlButton;
        } else html = htmlNoButton;
        try{
            mimeMessageHelper = new MimeMessageHelper(mimeMessage, true);
            mimeMessageHelper.setFrom(sender);
            mimeMessageHelper.setTo(details.getRecipient());
            mimeMessageHelper.setText(html, true);
            mimeMessageHelper.setSubject(details.getSubject());

            javaMailSender.send(mimeMessage);
            return "Mail Sent to " + details.getRecipient();
        } catch (Exception e){
            return "Error sending multipart mail: " + e.getMessage();
        }
    }
}
